# 2.0 ì•„í‚¤í…ì²˜

## ğŸ¯ ì•„í‚¤í…ì²˜ ì² í•™

**"ê°•ë ¥í•œ ìƒìš© ì„œë¹„ìŠ¤ ì¡°í•©ìœ¼ë¡œ ë°±ì—”ë“œ ë¶€ë‹´ì„ ìµœì†Œí™”í•˜ê³  í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì— ì§‘ì¤‘"**

Firebaseì™€ AWSì˜ ê´€ë¦¬í˜• ì„œë¹„ìŠ¤ë¥¼ ì „ëµì ìœ¼ë¡œ ì¡°í•©í•˜ì—¬, ë³µì¡í•œ ì¸í”„ë¼ ìš´ì˜ ì—†ì´ í”„ë¡ íŠ¸ì—”ë“œ ì¤‘ì‹¬ ê°œë°œì— ì§‘ì¤‘í•©ë‹ˆë‹¤. ì¸ì¦Â·ì‹¤ì‹œê°„ DBÂ·í˜¸ìŠ¤íŒ…ì„ í´ë¼ìš°ë“œ ì œê³µìì—ê²Œ ìœ„ì„í•˜ê³ , í•„ìš”ì‹œ ì»¤ìŠ¤í…€ ë°±ì—”ë“œë¥¼ ì ì§„ì ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜ë¥¼ ì±„íƒí–ˆìŠµë‹ˆë‹¤.

**í•µì‹¬ ì„¤ê³„ ì›ì¹™**:
- ë¹ ë¥¸ MVP ì¶œì‹œ â†’ ì ì§„ì  í™•ì¥
- ê´€ë¦¬í˜• ì„œë¹„ìŠ¤ ìš°ì„ , í•„ìš”ì‹œ ì»¤ìŠ¤í…€ ë°±ì—”ë“œ ì¶”ê°€
- ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬ ë° ë³´ì•ˆ ë‚´ì¬í™”

---

## ğŸ“‹ ë¬¸ì œ ì •ì˜

**ìƒí™©**: AIoT ì„œë¹„ìŠ¤ í”Œë«í¼ MVP ê°œë°œ
**ì œì•½**: ì†Œê·œëª¨ íŒ€, ë¹ ë¥¸ ì‹œì¥ ì¶œì‹œ í•„ìš”
**ëª©í‘œ**: ì‚¬ìš©ìê°€ IoT ë””ë°”ì´ìŠ¤ë¥¼ ë“±ë¡Â·ëª¨ë‹ˆí„°ë§Â·ì œì–´í•  ìˆ˜ ìˆëŠ” ì‹¤ì‹œê°„ ì‹œê°í™” í”Œë«í¼

**í•µì‹¬ ìš”êµ¬ì‚¬í•­**:
- ì‚¬ìš©ì ì¸ì¦ (Email/Password, Google OAuth)
- ì‹¤ì‹œê°„ ë””ë°”ì´ìŠ¤ ìƒíƒœ ë™ê¸°í™”
- MQTT ë©”ì‹œì§€ ìˆ˜ì‹  ë° ì‹œê°í™”
- ì„¼ì„œ ë°ì´í„° ì˜êµ¬ ì €ì¥ (í™•ì¥ ì‹œë‚˜ë¦¬ì˜¤)
- ê¸€ë¡œë²Œ ë°°í¬ ë° ìë™ í™•ì¥

**ê¸°ìˆ  ìŠ¤íƒ ì„ íƒ ëª©í‘œ**:
ìƒìš© ì„œë¹„ìŠ¤ í™œìš©ìœ¼ë¡œ ìµœëŒ€ í¼í¬ë¨¼ìŠ¤ ë‹¬ì„± + ì ì§„ì  í™•ì¥ì„± í™•ë³´

---

## ğŸ›ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

### **ë‹¨ê³„ë³„ ì§„í™” ì „ëµ**

#### **Phase 1: Serverless-First MVP**
ë°±ì—”ë“œ ì„œë²„ ì—†ì´ Firebase + AWS ê´€ë¦¬í˜• ì„œë¹„ìŠ¤ë¡œ ì™„ì „í•œ IoT í”Œë«í¼ êµ¬ì„±

```
ì‚¬ìš©ì â†’ AWS Amplify (CDN + í˜¸ìŠ¤íŒ…)
         â†“
    Firebase Auth (ì¸ì¦)
         â†“
    Firestore (ì‹¤ì‹œê°„ DB)
         â†“
    MQTT Broker (ì‹¤ì‹œê°„ ë©”ì‹œì§€)
```

**íŠ¹ì§•**:
- ì„œë²„ ìš´ì˜ ë¶€ë‹´ ì œë¡œ
- Firebase ìë™ í™•ì¥
- ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”

#### **Phase 2: í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜ (í˜„ì¬ êµ¬í˜„)**
FirebaseëŠ” ì¸ì¦Â·ì‹¤ì‹œê°„ ë°ì´í„°ì— ì§‘ì¤‘, Express ë°±ì—”ë“œë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§Â·ì˜êµ¬ ì €ì¥ ì²˜ë¦¬

```
ì‚¬ìš©ì â†’ Amplify â†’ Frontend
              â†“
         Firebase Auth (ì¸ì¦Â·í† í°)
              â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
      â†“             â†“
  Firestore    Express Backend
 (ì‹¤ì‹œê°„ ìƒíƒœ)   (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)
                    â†“
                  MySQL
              (ì„¼ì„œ ë°ì´í„° ì˜êµ¬ ì €ì¥)
```

**ì„¤ê³„ ì›ì¹™**:
- âœ… **ê´€ë¦¬í˜• ìš°ì„ **: ì¸ì¦Â·ì‹¤ì‹œê°„ DBëŠ” Firebase
- âœ… **ìœ ì—°í•œ í™•ì¥**: ë³µì¡í•œ ë¡œì§ì€ Expressë¡œ ì²˜ë¦¬
- âœ… **ë°ì´í„° ë¶„ë¦¬**: ì‹¤ì‹œê°„ vs ì˜êµ¬ ì €ì¥ì†Œ ë¶„ë¦¬
- âœ… **ë³´ì•ˆ ë‚´ì¬í™”**: Firebase ID í† í° ê¸°ë°˜ ì¸ì¦

---

## ğŸ”§ ê¸°ìˆ  ìŠ¤íƒ

### **í”„ë¡ íŠ¸ì—”ë“œ**

| ê³„ì¸µ | ê¸°ìˆ  | ë²„ì „ | ì„ íƒ ì´ìœ  |
|------|------|------|-----------|
| **ë¹Œë“œ ë„êµ¬** | Vite | ^5.0.0 | ë¹ ë¥¸ ê°œë°œ ì„œë²„, ìµœì í™”ëœ ë²ˆë“¤ë§ |
| **í”„ë ˆì„ì›Œí¬** | Vanilla JS | - | ê²½ëŸ‰í™”, í•™ìŠµ ì§„ì…ì¥ë²½ ìµœì†Œí™” |
| **ì¸ì¦Â·DB** | Firebase SDK | ^10.8.0 | Auth + Firestore í†µí•©, ì‹¤ì‹œê°„ ë™ê¸°í™” |
| **ìŠ¤íƒ€ì¼** | Tailwind CSS | CDN | ìœ í‹¸ë¦¬í‹° ê¸°ë°˜ ë¹ ë¥¸ UI êµ¬ì„± |
| **ì‹¤ì‹œê°„ í†µì‹ ** | MQTT.js | - | IoT í‘œì¤€ í”„ë¡œí† ì½œ, WebSocket ì§€ì› |
| **ì°¨íŠ¸** | Chart.js | - | ê°„ë‹¨í•œ ì‹œê°í™” |
| **í˜¸ìŠ¤íŒ…** | AWS Amplify | - | Git ì—°ë™ ìë™ ë°°í¬, CloudFront CDN |

**Firebase í•µì‹¬ ê¸°ëŠ¥**:
- **Firebase Auth**: Email/Google OAuth ì¦‰ì‹œ ì‚¬ìš©, í† í° ìë™ ê´€ë¦¬
- **Firestore**: onSnapshot ì‹¤ì‹œê°„ ë™ê¸°í™”, ì˜¤í”„ë¼ì¸ ìºì‹±, ìë™ í™•ì¥
- **Security Rules**: ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬

### **ë°±ì—”ë“œ (ì„ íƒì  í™•ì¥)**

| ê³„ì¸µ | ê¸°ìˆ  | ë²„ì „ | ì„ íƒ ì´ìœ  |
|------|------|------|-----------|
| **ëŸ°íƒ€ì„** | Node.js | â‰¥18.17.0 | JavaScript ìƒíƒœê³„ í™œìš© |
| **í”„ë ˆì„ì›Œí¬** | Express | ^4.19.2 | ê°„ê²°í•œ API êµ¬ì„±, ë¯¸ë“¤ì›¨ì–´ ìƒíƒœê³„ |
| **ì–¸ì–´** | TypeScript | ^5.4.5 | íƒ€ì… ì•ˆì „ì„±, ìë™ ì™„ì„± |
| **ì¸ì¦** | Firebase Admin | ^12.5.0 | ID í† í° ì„œë²„ ê²€ì¦ |
| **ë°ì´í„°ë² ì´ìŠ¤** | MySQL | 8.0 | ê´€ê³„í˜• ë°ì´í„°, íŠ¸ëœì­ì…˜ ì§€ì› |
| **DB í´ë¼ì´ì–¸íŠ¸** | mysql2 | ^3.9.4 | Promise ê¸°ë°˜ ì¿¼ë¦¬ |
| **ê²€ì¦** | Zod | ^3.23.8 | ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ ì…ë ¥ ê²€ì¦ |
| **ë¡œê¹…** | Pino | ^9.4.0 | ê³ ì„±ëŠ¥ êµ¬ì¡°í™” ë¡œê¹… |
| **CORS** | cors | ^2.8.5 | ë„ë©”ì¸ í—ˆìš© ê´€ë¦¬ |

**ë°±ì—”ë“œ í•µì‹¬ ì—­í• **:
- Firebase ID í† í° ê²€ì¦
- ì„¼ì„œ ë°ì´í„° MySQL ì˜êµ¬ ì €ì¥
- ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
- ì™¸ë¶€ API ì—°ë™ (ë¯¸ë˜ í™•ì¥)

### **ì¸í”„ë¼ ë° ë°°í¬**

| í•­ëª© | ê¸°ìˆ  | ì—­í•  |
|------|------|------|
| **CDN** | CloudFront | ê¸€ë¡œë²Œ ì½˜í…ì¸  ì „ì†¡, DDoS ë°©ì–´ |
| **í˜¸ìŠ¤íŒ…** | AWS Amplify | ìë™ ë¹Œë“œÂ·ë°°í¬, SSL ê´€ë¦¬ |
| **ì»¨í…Œì´ë„ˆ** | Docker | MySQL ë¡œì»¬ ê°œë°œ í™˜ê²½ |
| **ë²„ì „ ê´€ë¦¬** | Git | ì†ŒìŠ¤ ê´€ë¦¬, Amplify ì—°ë™ |

---

## ğŸŒ í”Œë«í¼ ë””ìì¸

### **ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜**

```mermaid
graph TB
    subgraph "User Layer"
        U[ì‚¬ìš©ì<br/>Web Browser]
    end

    subgraph "CDN & Hosting Layer"
        CDN[CloudFront CDN<br/>ê¸€ë¡œë²Œ ì—£ì§€]
        AMP[AWS Amplify<br/>ì •ì  í˜¸ìŠ¤íŒ…]
    end

    subgraph "Frontend Application"
        FE[Vite Frontend<br/>Vanilla JS + Tailwind]
    end

    subgraph "Authentication & Real-time Layer"
        AUTH[Firebase Auth<br/>ì¸ì¦Â·í† í° ê´€ë¦¬]
        FS[Firestore<br/>ì‹¤ì‹œê°„ DB]
    end

    subgraph "Backend Layer (Phase 2)"
        API[Express API<br/>TypeScript]
    end

    subgraph "Data Layer"
        DB[(MySQL<br/>ì„¼ì„œ ë°ì´í„°)]
    end

    subgraph "IoT Layer"
        MQTT[MQTT Broker<br/>HiveMQ/Mosquitto]
    end

    U -->|HTTPS| CDN
    CDN --> AMP
    AMP --> FE
    FE -->|SDK| AUTH
    FE -->|SDK| FS
    FE -->|REST API| API
    FE -.->|WebSocket| MQTT
    API -->|Verify Token| AUTH
    API -->|SQL| DB
    AUTH -.->|Security Rules| FS
```

### **ë°ì´í„° í”Œë¡œìš°**

```mermaid
sequenceDiagram
    participant U as ì‚¬ìš©ì
    participant FE as Frontend
    participant AUTH as Firebase Auth
    participant FS as Firestore
    participant API as Express API
    participant DB as MySQL
    participant MQTT as MQTT Broker

    Note over U,AUTH: 1. ì¸ì¦ í”Œë¡œìš°
    U->>FE: Google ë¡œê·¸ì¸ í´ë¦­
    FE->>AUTH: signInWithPopup()
    AUTH-->>FE: User + ID Token

    Note over FE,FS: 2. ì‹¤ì‹œê°„ ë””ë°”ì´ìŠ¤ ë™ê¸°í™”
    FE->>FS: onSnapshot(devices)
    FS-->>FE: ì‹¤ì‹œê°„ ë””ë°”ì´ìŠ¤ ëª©ë¡

    Note over FE,MQTT: 3. MQTT ë©”ì‹œì§€ ìˆ˜ì‹ 
    MQTT->>FE: ì˜¨ë„ ì„¼ì„œ ë°ì´í„°
    FE->>FS: updateDoc(device, {lastTemp})
    FS-->>FE: ë³€ê²½ ì•Œë¦¼ â†’ UI ì—…ë°ì´íŠ¸

    Note over FE,DB: 4. ì„¼ì„œ ë°ì´í„° ì˜êµ¬ ì €ì¥ (Phase 2)
    FE->>API: POST /api/sensors/data (+ ID Token)
    API->>AUTH: verifyIdToken()
    AUTH-->>API: Verified User
    API->>DB: INSERT sensor_readings
    DB-->>API: Success
    API-->>FE: 200 OK
```

### **ë””ë ‰í† ë¦¬ êµ¬ì¡°**

```
aiot-dev-mgr-cld/
â”œâ”€â”€ aiot-device-manager-fe-working/    # í”„ë¡ íŠ¸ì—”ë“œ
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ config/                    # ì„¤ì • íŒŒì¼
â”‚   â”‚   â”‚   â”œâ”€â”€ firebase.config.js     # Firebase SDK ì„¤ì •
â”‚   â”‚   â”‚   â”œâ”€â”€ app.config.js          # ì•± ê°œì¸í™” ì„¤ì • (MQTT, í…Œë§ˆ)
â”‚   â”‚   â”‚   â””â”€â”€ backend.config.js      # ë°±ì—”ë“œ API URL
â”‚   â”‚   â”œâ”€â”€ services/                  # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”‚   â”‚   â”œâ”€â”€ FirebaseTokenManager.js    # í† í° ìºì‹± (2~10ë¶„)
â”‚   â”‚   â”‚   â”œâ”€â”€ BackendIntegrationService.js # API í†µì‹ 
â”‚   â”‚   â”‚   â””â”€â”€ sensorApi.js           # ì„¼ì„œ ë°ì´í„° API
â”‚   â”‚   â”œâ”€â”€ views/                     # í™”ë©´ ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”‚   â”œâ”€â”€ AuthView.js            # ë¡œê·¸ì¸ í™”ë©´
â”‚   â”‚   â”‚   â”œâ”€â”€ DeviceListView.js      # ë””ë°”ì´ìŠ¤ ëª©ë¡
â”‚   â”‚   â”‚   â””â”€â”€ DeviceDetailView.js    # ë””ë°”ì´ìŠ¤ ìƒì„¸
â”‚   â”‚   â”œâ”€â”€ components/                # UI ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”‚   â”œâ”€â”€ DeviceAddForm.js       # ë””ë°”ì´ìŠ¤ ì¶”ê°€ í¼
â”‚   â”‚   â”‚   â”œâ”€â”€ MQTTManager.js         # MQTT êµ¬ë… ê´€ë¦¬
â”‚   â”‚   â”‚   â””â”€â”€ TemperatureChart.js    # ì‹¤ì‹œê°„ ì°¨íŠ¸
â”‚   â”‚   â”œâ”€â”€ AppManager.js              # ì•± ì „ì²´ ìƒíƒœ ê´€ë¦¬
â”‚   â”‚   â””â”€â”€ app.js                     # ì§„ì…ì 
â”‚   â”œâ”€â”€ index.html                     # HTML ì—”íŠ¸ë¦¬ (Tailwind CDN)
â”‚   â”œâ”€â”€ vite.config.js                 # Vite ë¹Œë“œ ì„¤ì •
â”‚   â”œâ”€â”€ amplify.yml                    # AWS Amplify ë°°í¬ ì„¤ì •
â”‚   â””â”€â”€ package.json                   # ì˜ì¡´ì„± ê´€ë¦¬
â”‚
â”œâ”€â”€ aiot-device-manager-be-working/    # ë°±ì—”ë“œ (Phase 2)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”œâ”€â”€ env.ts                 # í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ (Zod)
â”‚   â”‚   â”‚   â””â”€â”€ firebase.ts            # Firebase Admin ì´ˆê¸°í™”
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â””â”€â”€ firebaseAuth.ts        # ID í† í° ê²€ì¦ ë¯¸ë“¤ì›¨ì–´
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â””â”€â”€ sensorRoutes.ts        # POST /api/sensors/data
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ sensorService.ts       # ì„¼ì„œ ë°ì´í„° ì €ì¥ ë¡œì§
â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â””â”€â”€ pool.ts                # MySQL ì»¤ë„¥ì…˜ í’€
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â””â”€â”€ logger.ts              # Pino ë¡œê¹…
â”‚   â”‚   â”œâ”€â”€ app.ts                     # Express ì•± ì„¤ì •
â”‚   â”‚   â””â”€â”€ server.ts                  # ì„œë²„ ì‹œì‘
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â””â”€â”€ schema.sql                 # MySQL DDL
â”‚   â”œâ”€â”€ docker-compose.yml             # MySQL ì»¨í…Œì´ë„ˆ
â”‚   â”œâ”€â”€ tsconfig.json                  # TypeScript ì„¤ì •
â”‚   â””â”€â”€ package.json                   # ì˜ì¡´ì„± ê´€ë¦¬
â”‚
â””â”€â”€ docs/                              # ë¬¸ì„œ
    â”œâ”€â”€ 2.0ì•„í‚¤í…ì²˜.md                  # ë³¸ ë¬¸ì„œ
    â”œâ”€â”€ CLOUD_DEPLOYMENT_GUIDE.md      # ë°°í¬ ê°€ì´ë“œ
    â””â”€â”€ SECURITY_REVIEW.md             # ë³´ì•ˆ ê²€í† 
```

---

## ğŸ“¡ API ëª…ì„¸ì„œ

### **Firebase Auth API (í´ë¼ì´ì–¸íŠ¸)**

```javascript
// Google OAuth ë¡œê·¸ì¸
import { signInWithPopup, GoogleAuthProvider } from 'firebase/auth';

const provider = new GoogleAuthProvider();
const result = await signInWithPopup(auth, provider);
const user = result.user;
const idToken = await user.getIdToken(); // 1ì‹œê°„ ìœ íš¨

// ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸
await signInWithEmailAndPassword(auth, email, password);

// í† í° ìë™ ê°±ì‹  ê°ì§€
onIdTokenChanged(auth, async (user) => {
  if (user) {
    const token = await user.getIdToken(); // ìë™ ê°±ì‹ 
    // API í˜¸ì¶œ ì‹œ Authorization í—¤ë”ì— í¬í•¨
  }
});

// ë¡œê·¸ì•„ì›ƒ
await signOut(auth);
```

### **Firestore API (í´ë¼ì´ì–¸íŠ¸)**

```javascript
import { collection, onSnapshot, query, where, addDoc, updateDoc, deleteDoc } from 'firebase/firestore';

// ì‹¤ì‹œê°„ êµ¬ë… (ì‚¬ìš©ìë³„ ë””ë°”ì´ìŠ¤ë§Œ ì¡°íšŒ)
const q = query(
  collection(db, 'devices'),
  where('userId', '==', auth.currentUser.uid)
);

const unsubscribe = onSnapshot(q, (snapshot) => {
  snapshot.docChanges().forEach(change => {
    if (change.type === 'added') { /* ì‹ ê·œ ë””ë°”ì´ìŠ¤ */ }
    if (change.type === 'modified') { /* ìƒíƒœ ë³€ê²½ */ }
    if (change.type === 'removed') { /* ì‚­ì œ */ }
  });
});

// ë””ë°”ì´ìŠ¤ ì¶”ê°€
await addDoc(collection(db, 'devices'), {
  userId: auth.currentUser.uid,
  name: 'ê±°ì‹¤ ì˜¨ë„ì„¼ì„œ',
  type: 'sensor',
  status: 'online',
  createdAt: new Date()
});

// ë””ë°”ì´ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
await updateDoc(doc(db, 'devices', deviceId), {
  status: 'offline',
  lastSeen: new Date()
});

// ë””ë°”ì´ìŠ¤ ì‚­ì œ
await deleteDoc(doc(db, 'devices', deviceId));
```

### **Express Backend API (Phase 2)**

#### **ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡**

| Method | Path | ì¸ì¦ | ì„¤ëª… |
|--------|------|------|------|
| GET | `/health` | ë¶ˆí•„ìš” | í—¬ìŠ¤ ì²´í¬ |
| POST | `/api/sensors/data` | í•„ìˆ˜ | ì„¼ì„œ ë°ì´í„° ì €ì¥ |

#### **ì„¼ì„œ ë°ì´í„° ì €ì¥**

**Request**:
```http
POST /api/sensors/data
Authorization: Bearer <firebase-id-token>
Content-Type: application/json

{
  "deviceId": "device123",
  "temperature": 23.5,
  "humidity": 60,
  "timestamp": "2025-08-15T10:30:00Z"
}
```

**Response**:
```json
{
  "success": true,
  "readingId": 12345
}
```

**Error**:
```json
{
  "error": "Unauthorized",
  "message": "Invalid or expired token"
}
```

### **Firestore Security Rules**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ë””ë°”ì´ìŠ¤: ë³¸ì¸ ê²ƒë§Œ ì ‘ê·¼
    match /devices/{deviceId} {
      allow read, write: if request.auth != null
        && request.auth.uid == resource.data.userId;

      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId;
    }

    // ì‚¬ìš©ì í”„ë¡œí•„: ë³¸ì¸ ê²ƒë§Œ ì ‘ê·¼
    match /users/{userId} {
      allow read, write: if request.auth != null
        && request.auth.uid == userId;
    }
  }
}
```

### **MySQL ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ**

#### **í…Œì´ë¸” êµ¬ì¡°**

**users**: Firebase ì‚¬ìš©ì ì •ë³´
```sql
CREATE TABLE users (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  firebase_uid VARCHAR(128) UNIQUE NOT NULL,
  email VARCHAR(255),
  display_name VARCHAR(255),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**devices**: ë””ë°”ì´ìŠ¤ ì •ë³´
```sql
CREATE TABLE devices (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT UNSIGNED NOT NULL,
  device_id VARCHAR(128) NOT NULL,
  device_name VARCHAR(255),
  last_seen_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY (user_id, device_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

**sensor_readings**: ì„¼ì„œ ë°ì´í„° (Append-Only)
```sql
CREATE TABLE sensor_readings (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  device_id BIGINT UNSIGNED NOT NULL,
  recorded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  payload JSON NOT NULL,
  KEY (device_id, recorded_at),
  FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE
);
```

**ë°ì´í„° í”Œë¡œìš°**:
1. Frontendì—ì„œ Firebase Authë¡œ ì¸ì¦
2. Firebase ID Tokenì„ Backendë¡œ ì „ì†¡
3. Backendì—ì„œ Token ê²€ì¦ â†’ Firebase UID ì¶”ì¶œ
4. `users` í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì ì¡°íšŒ/ìƒì„±
5. `devices` í…Œì´ë¸”ì—ì„œ ë””ë°”ì´ìŠ¤ ì¡°íšŒ/ìƒì„±
6. `sensor_readings` í…Œì´ë¸”ì— ì„¼ì„œ ë°ì´í„° ì €ì¥

---

## âš™ï¸ í™˜ê²½ êµ¬ì„± ê°€ì´ë“œ

### **1. Firebase í”„ë¡œì íŠ¸ ì„¤ì •**

**Firebase Consoleì—ì„œ ìˆ˜í–‰**:
1. í”„ë¡œì íŠ¸ ìƒì„±
2. **Authentication** í™œì„±í™”
   - Email/Password í™œì„±í™”
   - Google OAuth í™œì„±í™”
   - ìŠ¹ì¸ëœ ë„ë©”ì¸ ì¶”ê°€: `localhost`, `*.amplifyapp.com`
3. **Firestore Database** ìƒì„± (í”„ë¡œë•ì…˜ ëª¨ë“œ)
4. **Security Rules** ì ìš© (ìœ„ API ëª…ì„¸ì„œ ì°¸ì¡°)
5. **ì›¹ ì•± ë“±ë¡** â†’ Firebase êµ¬ì„± ê°ì²´ ë³µì‚¬

### **2. í”„ë¡ íŠ¸ì—”ë“œ ë¡œì»¬ í™˜ê²½ ì„¤ì •**

```bash
cd aiot-device-manager-fe-working

# ì˜ì¡´ì„± ì„¤ì¹˜
npm install

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
cp .env.example .env
```

**.env íŒŒì¼**:
```bash
# Firebase SDK ì„¤ì •
VITE_FIREBASE_API_KEY=your-api-key
VITE_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your-project-id
VITE_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=123456789
VITE_FIREBASE_APP_ID=1:123456789:web:abcdef

# ë°±ì—”ë“œ API URL (Phase 2)
VITE_BACKEND_BASE_URL=http://localhost:4000

# í† í° ìºì‹± ì‹œê°„ (ë¶„)
VITE_TOKEN_CACHE_MINUTES=5
```

**ê°œë°œ ì„œë²„ ì‹¤í–‰**:
```bash
npm run dev
# http://localhost:5173 ì ‘ì†
```

### **3. ë°±ì—”ë“œ ë¡œì»¬ í™˜ê²½ ì„¤ì • (Phase 2)**

```bash
cd aiot-device-manager-be-working

# ì˜ì¡´ì„± ì„¤ì¹˜
npm install

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
cp .env.example .env
```

**.env íŒŒì¼**:
```bash
# Express ì„œë²„
PORT=4000

# MySQL ì—°ê²°
MYSQL_HOST=127.0.0.1
MYSQL_PORT=3306
MYSQL_USER=appuser
MYSQL_PASSWORD=appsecret
MYSQL_DATABASE=aiot_device_manager

# Firebase Admin SDK
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_CLIENT_EMAIL=firebase-adminsdk@your-project.iam.gserviceaccount.com
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"

# CORS í—ˆìš© ë„ë©”ì¸
ALLOWED_ORIGINS=http://localhost:5173,https://your-app.amplifyapp.com
```

**Firebase ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ë°œê¸‰**:
1. Firebase Console â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì„œë¹„ìŠ¤ ê³„ì •
2. "ìƒˆ ë¹„ê³µê°œ í‚¤ ìƒì„±" â†’ JSON ë‹¤ìš´ë¡œë“œ
3. JSON íŒŒì¼ì—ì„œ `client_email`, `private_key` ì¶”ì¶œ
4. `.env`ì— ë¶™ì—¬ë„£ê¸° (ì¤„ë°”ê¿ˆ `\n` ìœ ì§€)

**MySQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰**:
```bash
docker compose up -d
# MySQL 8.0 ì»¨í…Œì´ë„ˆ ì‹œì‘
# schema.sql ìë™ ì‹¤í–‰
```

**ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰**:
```bash
npm run dev
# http://localhost:4000
```

### **4. MQTT ë¸Œë¡œì»¤ ì„¤ì •**

**app.config.jsì—ì„œ ë¸Œë¡œì»¤ ì„ íƒ**:
```javascript
mqtt: {
  brokerOption: "broker-option1", // ë³€ê²½ ê°€ëŠ¥

  brokerOptions: {
    "broker-option1": {
      name: "HiveMQ Public Broker",
      url: "ws://broker.hivemq.com:8000/mqtt"
    },
    "broker-option4": {
      name: "Mosquitto Test Broker",
      url: "ws://test.mosquitto.org:8080/mqtt"
    },
    // ë¡œì»¬ ë¸Œë¡œì»¤ ì‚¬ìš© ì‹œ
    "broker-option6": {
      name: "Local Mosquitto Broker",
      url: "ws://localhost:9001/mqtt"
    }
  },

  // í† í”½ ê°œì¸í™” (ë‹¤ë¥¸ ìˆ˜ê°•ìƒê³¼ ì¤‘ë³µ ë°©ì§€)
  topicPrefix: "kiot/your-unique-id/"
}
```

**ë¡œì»¬ Mosquitto ì„¤ì¹˜ (ì„ íƒì‚¬í•­)**:
```bash
# macOS
brew install mosquitto

# ì‹¤í–‰
mosquitto -c /usr/local/etc/mosquitto/mosquitto.conf
```

---

## ğŸš€ ë°°í¬Â·ìš´ì˜ ê°€ì´ë“œ

### **AWS Amplify ë°°í¬**

#### **1ë‹¨ê³„: GitHub ì—°ê²°**

1. Amplify Console â†’ "New app" â†’ "Host web app"
2. GitHub/GitLab ì €ì¥ì†Œ ì—°ê²°
3. ë¸Œëœì¹˜ ì„ íƒ (main)
4. ì•± ë£¨íŠ¸ ë””ë ‰í† ë¦¬: `aiot-device-manager-fe-working`

#### **2ë‹¨ê³„: ë¹Œë“œ ì„¤ì • (amplify.yml)**

```yaml
version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
```

#### **3ë‹¨ê³„: í™˜ê²½ ë³€ìˆ˜ ì£¼ì…**

Amplify Console â†’ App settings â†’ Environment variables

```
VITE_FIREBASE_API_KEY = <Firebase ê°’>
VITE_FIREBASE_AUTH_DOMAIN = <Firebase ê°’>
VITE_FIREBASE_PROJECT_ID = <Firebase ê°’>
VITE_FIREBASE_STORAGE_BUCKET = <Firebase ê°’>
VITE_FIREBASE_MESSAGING_SENDER_ID = <Firebase ê°’>
VITE_FIREBASE_APP_ID = <Firebase ê°’>
VITE_BACKEND_BASE_URL = <ë°±ì—”ë“œ URL>
```

#### **4ë‹¨ê³„: ë°°í¬ ì™„ë£Œ**

- Git Push ì‹œ ìë™ ë¹Œë“œÂ·ë°°í¬
- ë°°í¬ URL: `https://<branch>.<app-id>.amplifyapp.com`
- **ì¤‘ìš”**: Firebase Console â†’ Authentication â†’ ìŠ¹ì¸ëœ ë„ë©”ì¸ì— Amplify URL ì¶”ê°€

### **ë°±ì—”ë“œ ë°°í¬ (Phase 2)**

**Docker ì»¨í…Œì´ë„ˆí™”**:
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --production
COPY dist ./dist
CMD ["node", "dist/server.js"]
```

**ë°°í¬ ì˜µì…˜**:
- AWS ECS/Fargate
- AWS Elastic Beanstalk
- Google Cloud Run
- ì¼ë°˜ VPS (PM2)

**í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬**:
- AWS Systems Manager Parameter Store
- AWS Secrets Manager
- í™˜ê²½ë³„ `.env` íŒŒì¼ (CI/CD)

### **ëª¨ë‹ˆí„°ë§**

#### **Firebase Console**
- Authentication â†’ ì‚¬ìš©ì í™œë™ ì¶”ì 
- Firestore â†’ ì½ê¸°/ì“°ê¸° í†µê³„
- Usage â†’ ë¹„ìš© ëª¨ë‹ˆí„°ë§

#### **Amplify Console**
- Monitoring â†’ ë¹Œë“œ íˆìŠ¤í† ë¦¬
- íŠ¸ë˜í”½ í†µê³„
- ì—ëŸ¬ ë¡œê·¸

#### **ë°±ì—”ë“œ ë¡œê·¸ (Pino)**
```bash
# ë¡œì»¬ ê°œë°œ
npm run dev
# Pretty-print ë¡œê·¸ ì¶œë ¥

# í”„ë¡œë•ì…˜
npm start
# JSON í˜•ì‹ ë¡œê·¸ â†’ CloudWatch/ELK ì—°ë™
```

### **í™•ì¥ ì‹œë‚˜ë¦¬ì˜¤**

#### **Phase 3: ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤**
```
Frontend â†’ API Gateway
            â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
   â†“        â†“        â†“
Device   Sensor   Analytics
Service  Service  Service
   â†“        â†“        â†“
  DB1      DB2      DB3
```

**ì¶”ê°€ ê°€ëŠ¥ ê¸°ëŠ¥**:
- ë°ì´í„° ë¶„ì„ (Pandas/NumPy)
- ì•Œë¦¼ ì‹œìŠ¤í…œ (FCM/SNS)
- ì™¸ë¶€ API ì—°ë™ (ERP, CRM)
- ë¨¸ì‹ ëŸ¬ë‹ ì˜ˆì¸¡ (TensorFlow)

---

## ğŸ“ í•µì‹¬ í‚¤ì›Œë“œ

**Firebase ì‹¬í™” í•™ìŠµ**:
- `Firebase Security Rules` â†’ ê³ ê¸‰ ì ‘ê·¼ ì œì–´, í•¨ìˆ˜ ê¸°ë°˜ ê·œì¹™
- `Firestore Indexes` â†’ ë³µí•© ì¿¼ë¦¬ ìµœì í™”
- `Firebase Extensions` â†’ ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ (Resize Images, Send Emails)
- `Firebase Cloud Functions` â†’ ë°±ì—”ë“œ ë¡œì§ ì¶”ê°€

**ì‹¤ì‹œê°„ í†µì‹ **:
- `MQTT over WebSocket` â†’ QoS ë ˆë²¨, Retain ë©”ì‹œì§€
- `MQTT Topics` â†’ ì™€ì¼ë“œì¹´ë“œ, ê³„ì¸µ êµ¬ì¡°
- `Firebase Realtime Database` â†’ Firestore vs RTDB ë¹„êµ

**í”„ë¡ íŠ¸ì—”ë“œ ìµœì í™”**:
- `Vite Plugin Ecosystem` â†’ PWA, ì´ë¯¸ì§€ ìµœì í™”
- `Code Splitting` â†’ ë™ì  import, ë²ˆë“¤ ë¶„í• 
- `Service Worker` â†’ ì˜¤í”„ë¼ì¸ ìºì‹±

**AWS ì¸í”„ë¼**:
- `CloudFront Cache Invalidation` â†’ CDN ìºì‹œ ê´€ë¦¬
- `Amplify Environment` â†’ ë¸Œëœì¹˜ë³„ ë°°í¬, Preview
- `AWS WAF` â†’ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°©í™”ë²½

**ë°±ì—”ë“œ ì„¤ê³„**:
- `JWT Token Verification` â†’ Firebase Admin SDK
- `Database Indexing` â†’ MySQL ì¸ë±ìŠ¤ ì „ëµ
- `API Rate Limiting` â†’ express-rate-limit
- `Database Connection Pooling` â†’ ì»¤ë„¥ì…˜ ìµœì í™”

**ìš´ì˜ ê´€ì **:
- ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ê³¼ê¸ˆ ëª¨ë‹ˆí„°ë§
- Firestore ì½ê¸°/ì“°ê¸° ìµœì í™” (onSnapshot íš¨ìœ¨í™”)
- Firebase ID í† í° ìºì‹± ì „ëµ
- MySQL Slow Query ë¶„ì„
- ë¡œê·¸ ì§‘ê³„ ë° ì•Œë¦¼ (CloudWatch, Sentry)

**í™•ì¥ í•™ìŠµ ê²½ë¡œ**:
1. **1ë‹¨ê³„**: Firebase Auth + Firestoreë§Œìœ¼ë¡œ MVP ì™„ì„±
2. **2ë‹¨ê³„**: Express + MySQL ì¶”ê°€, ì„¼ì„œ ë°ì´í„° ì˜êµ¬ ì €ì¥
3. **3ë‹¨ê³„**: Redis ìºì‹±, Load Balancer ì¶”ê°€
4. **4ë‹¨ê³„**: ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë¶„ë¦¬, Kubernetes ë°°í¬

---

## ğŸ“š ì°¸ê³  ìë£Œ

**ê³µì‹ ë¬¸ì„œ**:
- [Firebase Documentation](https://firebase.google.com/docs)
- [AWS Amplify Guide](https://docs.amplify.aws/)
- [Vite Guide](https://vitejs.dev/guide/)
- [Express.js](https://expressjs.com/)
- [MQTT Protocol](https://mqtt.org/)

**ë³´ì•ˆ ê°€ì´ë“œ**:
- [Firebase Security Rules](https://firebase.google.com/docs/rules)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)

**ì•„í‚¤í…ì²˜ íŒ¨í„´**:
- [The Twelve-Factor App](https://12factor.net/)
- [Cloud Design Patterns](https://learn.microsoft.com/en-us/azure/architecture/patterns/)
