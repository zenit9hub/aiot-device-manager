# 앰플리파이 연동 가이드

이 문서는 본 리포지토리를 AWS Amplify로 배포하는 절차를 정리합니다.  
모노레포 구조를 기준으로 `aiot-dvc-mgr-fe-2.0-refactoring` 앱을 자동 빌드/배포합니다.

## 1) 사전 준비
- GitHub에 리포지토리 푸시 완료
- Firebase Console 접근 권한 확보
- (선택) MQTT 브로커 WSS 주소 준비

## 2) Amplify 앱 생성
1. [Amplify Console](https://console.aws.amazon.com/amplify/) 접속
2. **New app** → **Host web app**
3. GitHub 연결 → 리포지토리 선택
4. **브랜치 선택**: 예) `feature/phase1-refactor`
5. **Build settings**에서 `amplify.yml` 자동 인식 확인

### amplify.yml (루트 위치)
```yaml
version: 1
applications:
  - appRoot: aiot-dvc-mgr-fe-2.0-refactoring
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
        build:
          commands:
            - npm run build
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
```

## 3) Amplify 환경 변수 등록
Amplify Console → **App settings → Environment variables**

필수 값:
```
VITE_FIREBASE_API_KEY
VITE_FIREBASE_AUTH_DOMAIN
VITE_FIREBASE_PROJECT_ID
VITE_FIREBASE_STORAGE_BUCKET
VITE_FIREBASE_MESSAGING_SENDER_ID
VITE_FIREBASE_APP_ID
VITE_FIREBASE_MEASUREMENT_ID
```

MQTT 옵션:
```
VITE_MQTT_BROKER_URL=wss://broker.emqx.io:8084/mqtt
VITE_MQTT_TOPIC=aiot/devices/+/status
```

## 4) Firebase 승인 도메인 추가 (중요)
Firebase Console → **Authentication → Settings → Authorized domains**에 아래 도메인을 추가합니다.
- `localhost`
- `*.amplifyapp.com`
- 실제 배포 URL (예: `https://<branch>.<app-id>.amplifyapp.com`)

## 5) 배포 테스트
1. Amplify에서 빌드 완료 확인
2. 배포 URL 접속 → 로그인 및 디바이스 모니터링 동작 확인

## 6) FAQ
- **HTTPS 배포에서 WS 연결이 안됨**  
  HTTPS 환경에서는 `ws://`가 차단됩니다. 반드시 `wss://` 브로커를 사용하세요.

- **Firebase 로그인 실패**  
  Firebase 승인 도메인에 Amplify URL이 등록되어 있는지 확인하세요.

- **Firestore 권한 오류**  
  `users/{uid}/devices` 구조를 사용하는지, 보안 규칙이 UID 기반으로 설정되었는지 확인하세요.  

---
업데이트가 필요하면 이 문서를 계속 확장해 주세요.  
